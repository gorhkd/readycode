name: deploy-backend
on:
  workflow_dispatch:
  push:
    branches: [ infra/epic ]
    paths:
      - '.github/workflows/**'
      - 'infra/**'
permissions:
  id-token: write
  contents: read

defaults:
  run:
    working-directory: backend

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Make gradlew executable
        run: chmod +x gradlew

      - name: Build JAR
        run: ./gradlew clean bootJar

      - name: Prepare artifact name
        run: |
          JAR="$(ls build/libs/*-SNAPSHOT*.jar 2>/dev/null || ls build/libs/*.jar | head -n 1)"
          echo "Found: $JAR"
          cp "$JAR" build/libs/app.jar

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ap-northeast-2

      - name: Upload to S3
        run: aws s3 cp build/libs/app.jar s3://readycode-artifacts-gorhkd223-ap-northeast-2/server/app.jar

      - name: Deploy via SSM
        id: ssm
        run: |
          set -euo pipefail
          CMD_ID=$(aws ssm send-command \
            --region ap-northeast-2 \
            --instance-ids "${{ secrets.EC2_INSTANCE_ID }}" \
            --document-name "AWS-RunShellScript" \
            --comment "Deploy readycode app" \
            --parameters 'commands=["#!/bin/bash
              set -euo pipefail
              APP_NAME=readycode
              APP_PATH=/home/ubuntu/app.jar
              S3_BUCKET=readycode-artifacts-gorhkd223-ap-northeast-2
              S3_KEY=server/app.jar
          
              command -v jq >/dev/null 2>&1 || sudo apt-get update -y && sudo apt-get install -y jq
          
              echo Backing up old jar
              if [ -f \"$APP_PATH\" ]; then cp $APP_PATH /home/ubuntu/app-rollback.jar; fi
          
              echo Downloading new jar
              aws s3 cp s3://$S3_BUCKET/$S3_KEY $APP_PATH
          
              echo Restarting service
              sudo systemctl restart $APP_NAME
          
              echo Health check - waiting for service to be ready
              for i in {1..24}; do
                sleep 5
                # 로컬호스트에서 헬스체크 (보안그룹 영향 없음)
                if curl -f -s http://localhost:8080/actuator/health > /dev/null 2>&1; then
                  echo Service is UP - checking detailed status
                  STATUS=$(curl -s http://localhost:8080/actuator/health | jq -r .status 2>/dev/null || echo UNKNOWN)
                  echo Health status: $STATUS
                  if [ \"$STATUS\" = \"UP\" ]; then
                    echo SUCCESS - Deployment completed
                    exit 0
                  fi
                fi
                echo Attempt $i/24: Service not ready yet, waiting...
              done
          
              echo FAIL - Service did not come up in time, rolling back
              if [ -f /home/ubuntu/app-rollback.jar ]; then
                cp /home/ubuntu/app-rollback.jar $APP_PATH
                sudo systemctl restart $APP_NAME
                echo Rollback completed
              fi
              exit 1
            "]' \
            --query "Command.CommandId" --output text)
          
          echo "command_id=$CMD_ID" >> $GITHUB_OUTPUT

      - name: Resolve actual targets (debug)
        id: resolve
        run: |
          set -euo pipefail
          # 실제로 이 CommandId가 어떤 인스턴스를 대상으로 잡았는지 조회
          for i in {1..12}; do
            JSON=$(aws ssm list-command-invocations \
              --region ap-northeast-2 \
              --command-id "${{ steps.ssm.outputs.command_id }}" \
              --details \
              --output json)
            TARGETS=$(echo "$JSON" | jq -r '.CommandInvocations[].InstanceId')
            echo "Command targets so far: $TARGETS"
            if [ -n "$TARGETS" ]; then
              echo "targets=$TARGETS" >> $GITHUB_OUTPUT
              break
            fi
            sleep 5
          done
          if [ -z "${TARGETS:-}" ]; then
            echo "No targets resolved for the command. Likely wrong InstanceId/region or IAM policy scoping."
            exit 1
          fi

      - name: Wait SSM result (robust)
        run: |
          set -euo pipefail
          CMD_ID="${{ steps.ssm.outputs.command_id }}"
          TARGETS="${{ steps.resolve.outputs.targets }}"

          echo "Waiting for command $CMD_ID on targets: $TARGETS"
          # 여러 타깃일 수도 있으니 전부 성공해야 성공으로 간주
          for i in {1..60}; do
            ALL_OK=true
            for T in $TARGETS; do
              STATUS=$(aws ssm get-command-invocation \
                --region ap-northeast-2 \
                --command-id "$CMD_ID" \
                --instance-id "$T" \
                --query 'Status' --output text || echo "InvocationDoesNotExist")
              echo "[$T] $STATUS"
              case "$STATUS" in
                Success) : ;;
                Failed|Cancelled|TimedOut) exit 1 ;;
                InvocationDoesNotExist|Pending|InProgress|Delayed)
                  ALL_OK=false
                  ;;
                *) ALL_OK=false ;;
              esac
            done
            $ALL_OK && exit 0
            sleep 5
          done
          echo "Timed out waiting SSM"; exit 1
