name: deploy
on:
  workflow_dispatch:
  push:
    branches: [ infra/epic ]
    paths:
      - '.github/workflows/**'
      - 'infra/**'
permissions:
  id-token: write
  contents: read

defaults:
  run:
    working-directory: backend

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Make gradlew executable
        run: chmod +x gradlew

      - name: Build JAR
        run: ./gradlew clean bootJar

      - name: Prepare artifact name
        run: |
          JAR="$(ls build/libs/*-SNAPSHOT*.jar 2>/dev/null || ls build/libs/*.jar | head -n 1)"
          echo "Found: $JAR"
          cp "$JAR" build/libs/app.jar

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ap-northeast-2

      - name: Upload to S3
        run: aws s3 cp build/libs/app.jar s3://readycode-artifacts-gorhkd223-ap-northeast-2/server/app.jar

      - name: Deploy via SSM
        id: ssm
        run: |
          CMD_ID=$(aws ssm send-command \
            --instance-ids "${{ secrets.EC2_INSTANCE_ID }}" \
            --document-name "AWS-RunShellScript" \
            --comment "Deploy readycode app" \
            --parameters 'commands=["#!/bin/bash
              set -euo pipefail
              APP_NAME=readycode
              APP_PATH=/home/ubuntu/app.jar
              S3_BUCKET=readycode-artifacts-gorhkd223-ap-northeast-2
              S3_KEY=server/app.jar

              command -v jq >/dev/null 2>&1 || sudo apt-get update -y && sudo apt-get install -y jq

              echo Backing up old jar
              if [ -f \"$APP_PATH\" ]; then cp $APP_PATH /home/ubuntu/app-rollback.jar; fi

              echo Downloading new jar
              aws s3 cp s3://$S3_BUCKET/$S3_KEY $APP_PATH

              echo Restarting service
              sudo systemctl restart $APP_NAME

              echo Health check
              for i in {1..12}; do
                sleep 5
                STATUS=$(curl -s http://127.0.0.1:8080/actuator/health | jq -r .status || true)
                if [ \"$STATUS\" = \"UP\" ]; then
                  echo SUCCESS
                  exit 0
                fi
              done

              echo FAIL, rollback
              cp /home/ubuntu/app-rollback.jar $APP_PATH || true
              sudo systemctl restart $APP_NAME || true
              exit 1
            "]' \
            --query "Command.CommandId" --output text)

          echo "command_id=$CMD_ID" >> $GITHUB_OUTPUT

      - name: Wait SSM result
        run: |
          for i in {1..60}; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id "${{ steps.ssm.outputs.command_id }}" \
              --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
              --query 'Status' --output text || echo "Pending")
            echo "SSM Status: $STATUS"
            if [ "$STATUS" = "Success" ]; then exit 0; fi
            if [ "$STATUS" = "Failed" ] || [ "$STATUS" = "Cancelled" ] || [ "$STATUS" = "TimedOut" ]; then exit 1; fi
            sleep 5
          done
          echo "Timed out waiting SSM"; exit 1